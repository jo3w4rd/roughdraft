<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);  })(window,document,'script','dataLayer','GTM-5V25JL6');</script>
    <script type="text/javascript">thisPackageMetaData = { version: "0.7.0-preview.8", displayTitle:"Unity Entities Documentation 0.7.0-preview.8" };</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
  
    <title>Looking up data | Unity Entities Documentation | 0.7.0-preview.8 </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Looking up data | Unity Entities Documentation | 0.7.0-preview.8 ">
    <meta name="generator" content="docfx 2.40.12.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/version-switcher.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    <meta property="unity:packageTitle" content="Unity Entities Documentation | 0.7.0-preview.8">
    <meta property="docfx:rel" content="../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" class="manual">
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
        
        		<div class="back-to-unity-group">
        			<a class="back-to-unity" href="http://docs.unity3d.com/">docs.unity3d.com</a>
        		</div>
        
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items"></div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10" id="main_content">
          <div id="breadcrumb_placeholder"></div>
            <article class="content wrap" id="_content" data-uid="ecs-data-lookup">
<h1 id="looking-up-data">Looking up data</h1>

<p>The most efficient way to access and modify your ECS data is to use a system with an entity query and job. This provides the best utilization of CPU resources with the fewest memory cache misses. In fact, one of the goals of your data design should be to perform the bulk of your data transformation using the most efficient, fastest path. However, sometimes you need to access an arbitrary component of an arbitrary entity at an arbitrary point in your program.</p>
<p>Given an Entity object, you can look up data in its <a class="xref" href="component_data.html">IComponentData</a> and <a class="xref" href="dynamic_buffers.html">dynamic buffers</a>. The method varies depending on whether your code executes in a system using <a class="xref" href="../api/Unity.Entities.SystemBase.html#Unity_Entities_SystemBase_Entities">Entities.ForEach</a> or using an <a class="xref" href="../api/Unity.Entities.IJobChunk.html">IJobChunk</a> job, or elsewhere on the main thread.</p>
<p>To randomly access component data in a job, use one of the following types to get an array-like interface to component, indexed by Entity object:</p>
<ul>
<li><a class="xref" href="../api/Unity.Entities.ComponentDataFromEntity-1.html">ComponentDataFromEntity</a></li>
<li><a class="xref" href="../api/Unity.Entities.BufferFromEntity-1.html">BufferFromEntity</a></li>
</ul>
<h2 id="looking-up-entity-data-in-entitiesforeach">Looking up entity data in Entities.ForEach</h2>
<p>To look up entity data in an <a class="xref" href="../api/Unity.Entities.SystemBase.html#Unity_Entities_SystemBase_Entities">Entities.ForEach</a> job, you must declare a local variable of type <a class="xref" href="../api/Unity.Entities.ComponentDataFromEntity-1.html">ComponentDataFromEntity</a> or <a class="xref" href="../api/Unity.Entities.BufferFromEntity-1.html">BufferFromEntity</a> in your <a class="xref" href="../api/Unity.Entities.SystemBase.html#Unity_Entities_SystemBase_OnUpdate_">OnUpdate()</a> method. You can then &quot;capture&quot; the local variable in your lambda function. </p>
<p>For example, if you had Target components with an Entity field identifying the entity to target, you could use the following code to rotate the tracking entities toward their target:</p>
<pre><code class="lang-cs" name="lookup-foreach">public class TrackingSystem : SystemBase
{
    protected override void OnUpdate()
    {
        ComponentDataFromEntity&lt;LocalToWorld&gt; entityTransforms
            = this.GetComponentDataFromEntity&lt;LocalToWorld&gt;(true);
        float deltaTime = this.Time.DeltaTime;

        Entities
            .WithReadOnly(entityTransforms)
            .ForEach((ref Rotation orientation,
                      in LocalToWorld transform,
                      in Target target) =&gt;
            {
                // Check to make sure the target Entity still exists
                if (!entityTransforms.Exists(target.entity))
                    return;

                // Look up the entity data
                float3 targetPosition = entityTransforms[target.entity].Position;

                // Calculate the rotation
                float3 displacement = targetPosition - transform.Position;
                float3 upReference = new float3(0, 1, 0);
                quaternion lookRotation =
                    quaternion.LookRotationSafe(displacement, upReference);

                orientation.Value =
                    math.slerp(orientation.Value, lookRotation, deltaTime);
            })
            .ScheduleParallel();
    }
}
</code></pre><h2 id="looking-up-entity-data-in-ijobchunk">Looking up entity data in IJobChunk</h2>
<p>To look up entity data in an <a class="xref" href="../api/Unity.Entities.IJobChunk.html">IJobChunk</a> job, you must declare a field of type <a class="xref" href="../api/Unity.Entities.ComponentDataFromEntity-1.html">ComponentDataFromEntity</a> or <a class="xref" href="../api/Unity.Entities.BufferFromEntity-1.html">BufferFromEntity</a>, and set the value of the field before scheduling the job.</p>
<p>For example, if you had Target components with an Entity field identifying the entities to target, you could add the following field to your job struct to look up the world position of the targets:</p>
<pre><code class="lang-cs" name="lookup-ijobchunk-declare">[ReadOnly]
public ComponentDataFromEntity&lt;LocalToWorld&gt; EntityPositions;
</code></pre><p>Note that this declaration uses the <a href="https://docs.unity3d.com/ScriptReference/Unity.Collections.ReadOnlyAttribute.html">ReadOnly</a> attribute. You should always declare ComponentDataFromEntity<t> objects as read-only unless you do write to the components you access.<p>
<p>You can set this field when scheduling the job as follows:</p>
<pre><code class="lang-cs" name="lookup-ijobchunk-set">var job = new ChaserSystemJob();
job.EntityPositions = this.GetComponentDataFromEntity&lt;LocalToWorld&gt;(true);
</code></pre><p>Inside the job&#39;s <code>Execute()</code> function, you can lookup the value of a component using an Entity object:</p>
<pre><code class="lang-cs" name="lookup-ijobchunk-read">float3 targetPosition = EntityPositions[targetEntity].Position;
</code></pre><p> The following, full example shows a system that moves entities that have a Target field containing the Entity object of their target towards the current location of the target:</p>
<pre><code class="lang-cs" name="lookup-ijobchunk">public class MoveTowardsEntitySystem : SystemBase
{
    private EntityQuery query;

    [BurstCompile]
    private struct MoveTowardsJob : IJobChunk
    {
        // Read-write data in the current chunk
        public ArchetypeChunkComponentType&lt;Translation&gt; PositionTypeAccessor;

        // Read-only data in the current chunk
        [ReadOnly]
        public ArchetypeChunkComponentType&lt;Target&gt; TargetTypeAccessor;
        
        // Read-only data stored (potentially) in other chunks
        [ReadOnly]
        public ComponentDataFromEntity&lt;LocalToWorld&gt; EntityPositions;

        // Non-entity data
        public float deltaTime;

        public void Execute(ArchetypeChunk chunk,
                            int chunkIndex,
                            int firstEntityIndex)
        {
            // Get arrays of the components in chunk
            NativeArray&lt;Translation&gt; positions
                = chunk.GetNativeArray&lt;Translation&gt;(PositionTypeAccessor);
            NativeArray&lt;Target&gt; targets
                = chunk.GetNativeArray&lt;Target&gt;(TargetTypeAccessor);

            for (int i = 0; i &lt; positions.Length; i++)
            {
                // Get the target Entity object
                Entity targetEntity = targets[i].entity;

                // Check that the target still exists
                if (!EntityPositions.Exists(targetEntity))
                    continue;

                // Update translation to move the chasing enitity toward the target 
                float3 targetPosition = EntityPositions[targetEntity].Position;
                float3 chaserPosition = positions[i].Value;

                float3 displacement = targetPosition - chaserPosition;
                positions[i] = new Translation
                {
                    Value = chaserPosition + displacement * deltaTime
                };
            }
        }
    }

    protected override void OnCreate()
    {
        // Select all entities that have Translation and Target Componentx
        query = this.GetEntityQuery
                (
                    typeof(Translation),
                    ComponentType.ReadOnly&lt;Target&gt;()
                );
    }

    protected override void OnUpdate()
    {
        // Create the job
        var job = new MoveTowardsJob();

        // Set the chunk data accessors
        job.PositionTypeAccessor =
            this.GetArchetypeChunkComponentType&lt;Translation&gt;(false);
        job.TargetTypeAccessor =
            this.GetArchetypeChunkComponentType&lt;Target&gt;(true);

        // Set the component data lookup field
        job.EntityPositions = this.GetComponentDataFromEntity&lt;LocalToWorld&gt;(true);

        // Set non-ECS data fields
        job.deltaTime = this.Time.DeltaTime;

        // Schedule the job using Dependency property
        this.Dependency = job.Schedule(query, this.Dependency);
    }
}
</code></pre><h2 id="data-access-errors">Data access errors</h2>
<p>If the data you are looking up overlaps the data you are directly reading and writing in the job, then random access can lead to race conditions and subtle bugs. When you are sure that there is no overlap between the specific entity data you are reading or writing directly in the job and the specific entity data you are reading or writing randomly, then you can mark the accessor object with the <a href="https://docs.unity3d.com/ScriptReference/Unity.Collections.NativeDisableParallelForRestrictionAttribute.html">NativeDisableParallelForRestriction</a> attribute. </p>
</t></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/Unity-Technologies/dots/blob/docs-systembase-changes/Samples/Packages/com.unity.entities/Documentation~/ecs_lookup_data.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2020 Unity Technologies<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    <script type="text/javascript" src="../styles/metadata-collector.js"></script>
    <script type="text/javascript" src="../styles/version-switcher.js"></script>
  </body>
</html>
