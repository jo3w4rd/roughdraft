<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Using IJobProcessComponentData </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Using IJobProcessComponentData ">
    <meta name="generator" content="docfx 2.40.7.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="../toc">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>

            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../../manual/ecs_principles_and_vision.html" title="Manual">Manual</a>
                      </li>
                      <li>
                          <a href="../../api/Unity.Collections.html" title="Script Reference">Script Reference</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="../ecs_principles_and_vision.html" title="The Unity Data-Oriented Tech Stack project" class="">The Unity Data-Oriented Tech Stack project</a>
                    </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a href="../getting_started/getting_started.html" title="Getting started" class="">Getting started</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../getting_started/ecs_introduction.html" title="Entity Component Systems" class="">Entity Component Systems</a>
                          </li>
                          <li class="">
                            <a href="../getting_started/hello_ecs.html" title="Hello (ECS) World" class="">Hello (ECS) World</a>
                          </li>
                          <li class="">
                            <a href="../getting_started/samples_overview.html" title="Samples" class="">Samples</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a href="../com.unity.entities/index.html" title="Unity Entity Component System" class="">Unity Entity Component System</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../com.unity.entities/index.html" title="Overview" class="">Overview</a>
                          </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../com.unity.entities/index.html" title="Core ECS" class="">Core ECS</a>
                              
                              <ul class="nav level3">
                                <li class="">
                                  <span class="expand-stub"></span>
                                  <a href="../com.unity.entities/ecs_entities.html" title="Entities" class="">Entities</a>
                                    
                                    <ul class="nav level4">
                                      <li class="">
                                        <a href="../com.unity.entities/world.html" title="Worlds" class="">Worlds</a>
                                      </li>
                                    </ul>  </li>
                                <li class="">
                                  <span class="expand-stub"></span>
                                  <a href="../com.unity.entities/ecs_components.html" title="Components" class="">Components</a>
                                    
                                    <ul class="nav level4">
                                      <li class="">
                                        <a href="../com.unity.entities/component_data.html" title="General Purpose Components" class="">General Purpose Components</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/shared_component_data.html" title="Shared Components" class="">Shared Components</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/system_state_components.html" title="System State Components" class="">System State Components</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/dynamic_buffers.html" title="Dynamic Buffer Components" class="">Dynamic Buffer Components</a>
                                      </li>
                                    </ul>  </li>
                                <li class="">
                                  <span class="expand-stub"></span>
                                  <a href="../com.unity.entities/ecs_systems.html" title="System" class="">System</a>
                                    
                                    <ul class="nav level4">
                                      <li class="">
                                        <a href="../com.unity.entities/component_system.html" title="Component Systems" class="">Component Systems</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/job_component_system.html" title="Job Component Systems" class="">Job Component Systems</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/entity_command_buffer.html" title="Entity Command Buffers" class="">Entity Command Buffers</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/system_update_order.html" title="System Update Order" class="">System Update Order</a>
                                      </li>
                                    </ul>  </li>
                                <li class="">
                                  <span class="expand-stub"></span>
                                  <a href="../com.unity.entities/chunk_iteration.html" title="Accessing Entity Data" class="">Accessing Entity Data</a>
                                    
                                    <ul class="nav level4">
                                      <li class="active">
                                        <a href="../com.unity.entities/entity_iteration_job.html" title="Using IJobProcessComponentData" class="active">Using IJobProcessComponentData</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/chunk_iteration_job.html" title="Using IJobChunk" class="">Using IJobChunk</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/entity_iteration_foreach.html" title="Using ComponentSystem and ForEach" class="">Using ComponentSystem and ForEach</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/manual_iteration.html" title="Manual iteration" class="">Manual iteration</a>
                                      </li>
                                      <li class="">
                                        <a href="../com.unity.entities/component_group.html" title="Component Groups" class="">Component Groups</a>
                                      </li>
                                    </ul>  </li>
                                <li class="">
                                  <a href="../com.unity.entities/version_numbers.html" title="Versions and Generations" class="">Versions and Generations</a>
                                </li>
                                <li class="">
                                  <span class="expand-stub"></span>
                                  <a href="../com.unity.entities/ecs_job_overview.html" title="Jobs in ECS" class="">Jobs in ECS</a>
                                    
                                    <ul class="nav level4">
                                      <li class="">
                                        <a href="../com.unity.entities/ecs_job_extensions.html" title="ECS Job System extensions" class="">ECS Job System extensions</a>
                                      </li>
                                    </ul>  </li>
                              </ul>  </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../com.unity.entities/index.html" title="Creating Gameplay" class="">Creating Gameplay</a>
                              
                              <ul class="nav level3">
                                <li class="">
                                  <a href="../com.unity.entities/transform_system.html" title="Transforms" class="">Transforms</a>
                                </li>
                                <li class="">
                                  <a href="../com.unity.entities/gp_rendering.html" title="Rendering" class="">Rendering</a>
                                </li>
                              </ul>  </li>
                        </ul>  </li>
                    <li class="">
                      <a href="../cheatsheet.html" title="Quick Reference" class="">Quick Reference</a>
                    </li>
                    <li class="">
                      <a href="../glossary.html" title="Glossary" class="">Glossary</a>
                    </li>
                    <li class="">
                      <a href="../resources.html" title="Learning Resources" class="">Learning Resources</a>
                    </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="using-ijobprocesscomponentdata">Using IJobProcessComponentData</h1>

<p>You can define an <code>IJobProcessComponentData</code> Job in a JobComponentSystem to read and write component data. </p>
<p>When the Job runs, the ECS framework finds all of the entities that have the required components and calls the Job’s Execute() function for each of them. The data is processed in the order it is laid out in memory and the Job runs in parallel, so a <code>IJobProcessComponentData</code> combines simplicity and efficiency.</p>
<p>The following example illustrates a simple system that uses <code>IJobProcessComponentData</code>. The Job reads a <code>RotationSpeed</code> component and writes to a <code>RotationQuaternion</code> component.</p>
<pre><code class="lang-c#">public class RotationSpeedSystem : JobComponentSystem
{
   // Use the [BurstCompile] attribute to compile a job with Burst.
   [BurstCompile]
   struct RotationSpeedJob : IJobProcessComponentData&lt;RotationQuaternion, RotationSpeed&gt;
   {
       public float DeltaTime;
       // The [ReadOnly] attribute tells the job scheduler that this job will not write to rotSpeed
       public void Execute(ref RotationQuaternion rotationQuaternion, [ReadOnly] ref RotationSpeed rotSpeed)
       {
           // Rotate something about its up vector at the speed given by RotationSpeed.  
           rotationQuaternion.Value = math.mul(math.normalize(rotationQuaternion.Value), quaternion.AxisAngle(math.up(), rotSpeed.RadiansPerSecond * DeltaTime));
       }
   }

// OnUpdate runs on the main thread.
// Any previously scheduled jobs reading/writing from Rotation or writing to RotationSpeed 
// will automatically be included in the inputDependencies.
protected override JobHandle OnUpdate(JobHandle inputDependencies)
   {
       var job = new RotationSpeedJob()
       {
           DeltaTime = Time.deltaTime
       };
       return job.Schedule(this, inputDependencies);
   }
}
</code></pre><p>Note: this system is part of the HelloCubes_02 example in the  <a href="https://github.com/Unity-Technologies/EntityComponentSystemSamples">ECS samples repository</a>.</p>
<h2 id="defining-the-ijobprocesscomponentdata-signature">Defining the IJobProcessComponentData signature</h2>
<p>The <code>IJobProcessComponentData</code> struct signature identifies which components your system operates on:</p>
<pre><code>struct RotationSpeedJob : IJobProcessComponentData&lt;RotationQuaternion, RotationSpeed&gt;
</code></pre><p>You can also use the following attributes to modify which entities the Job selects:</p>
<ul>
<li>[ExcludeComponent(typeof(T)] — excludes entities whose Archetype contains the component of type T. </li>
<li>[RequireComponentTag(typeof(T)] — only include entities whose Archetype contains a component of type T. Use this attribute when a system does not read or write to a component that still must be associated with an entity. </li>
</ul>
<p>For example, the following Job definition selects entities that have archetypes containing Gravity, RotationQuaternion, and RotationSpeed components, but not a Frozen component:</p>
<pre><code>[ExcludeComponent(typeof(Frozen))]
[RequireComponentTag(typeof(Gravity))]
[BurstCompile]
struct RotationSpeedJob : IJobProcessComponentData&lt;RotationQuaternion, RotationSpeed&gt;
</code></pre><p>If you need a more complex query to select the entities to operate upon, you can use an IJobChunk Job instead of IJobProcessComponentData.</p>
<h2 id="writing-the-execute-method">Writing the Execute() method</h2>
<p>The JobComponentSystem calls your Execute() method for each eligible entity, passing in the components identified by the IJobProcessComponentData signature. Thus, the parameters of your Execute() function must match the generic arguments you defined for the struct.</p>
<p>For example, the following Execute() method reads a RotationSpeed component and reads and writes a RotationQuaternion component. (Read/write is the default, so no attribute is needed.)</p>
<pre><code>public void Execute(ref RotationQuaternion rotationQuaternion, [ReadOnly] ref RotationSpeed rotSpeed){}
</code></pre><p>You can add attributes to the function parameters to help ECS optimize your system:</p>
<ul>
<li>[ReadOnly] — use for components that the function reads, but does not write.</li>
<li>[WriteOnly] — use for components that the function writes, but does not read.</li>
<li>[ChangeFilter] — use when you only want to run the function on entities for which that component value may have changed since the last time your system ran. </li>
</ul>
<p>Identifying read-only and write-only components allows the Job scheduler to schedule your Jobs efficiently. For example, the scheduler won’t schedule a Job that writes to a component at the same time as a Job that reads that component, but it can run two Jobs in parallel if they only read the same components.</p>
<p>Note that for efficiency, the change filter works on whole chunks of entities; it does not track individual entities. If a chunk has been accessed by another Job which had the ability to write to that type of component, then the ECS framework considers that chunk to have changed and includes all of the entities in the Job. Otherwise, the ECS framework excludes the entities in that chunk entirely. </p>
<p><a name="with-entity"></a></p>
<h2 id="using-ijobprocesscomponentdatawithentity">Using IJobProcessComponentDataWithEntity</h2>
<p>The Jobs implementing the IJobProcessComponentDataWithEntity interface behave much the same as those implementing IJobProcessComponentData. The difference is that the Execute() function signature in IJobProcessComponentDataWithEntity provides you with the Entity object for the current entity and the index into the extended, parallel arrays of components.</p>
<h3 id="using-the-entity-parameter">Using the Entity parameter</h3>
<p>You can use the Entity object to add commands to an EntityCommandBuffer. For example, you can add commands to add or remove components on that entity or to destroy the entity — all operations that cannot be done directly inside a Job to avoid race conditions. Command buffers allow you to perform any, potentially costly, calculations on a worker thread, while queuing up the actual insertions and deletions to be performed later on the main thread. </p>
<p>The following system, from the HelloCube_06_SpawnFromEntity example uses a command buffer to instantiate entities after calculating their positions in a Job:</p>
<pre><code class="lang-c#">public class HelloSpawnerSystem : JobComponentSystem
{
   // EndFrameBarrier provides the CommandBuffer
   EndFrameBarrier m_EndFrameBarrier;

   protected override void OnCreateManager()
   {
       // Cache the EndFrameBarrier in a field, so we don&#39;t have to get it every frame
       m_EndFrameBarrier = World.GetOrCreateManager&lt;EndFrameBarrier&gt;();
   }
   struct SpawnJob : IJobProcessComponentDataWithEntity&lt;HelloSpawner, LocalToWorld&gt;
   {
       public EntityCommandBuffer CommandBuffer;
       public void Execute(Entity entity, int index, [ReadOnly] ref HelloSpawner spawner,
           [ReadOnly] ref LocalToWorld location)
       {
           for (int x = 0; x &lt; spawner.CountX; x++)
           {
               for (int y = 0; y &lt; spawner.CountX; y++)
               {
                   var __instance __= CommandBuffer.Instantiate(spawner.Prefab);
                   // Place the instantiated in a grid with some noise
                   var position = math.transform(location.Value,
                       new float3(x * 1.3F, noise.cnoise(new float2(x, y) * 0.21F) * 2, y * 1.3F));
                   CommandBuffer.SetComponent(instance, new Translation {Value = position});
               }
           }
           CommandBuffer.DestroyEntity(entity);
       }
   }

   protected override JobHandle OnUpdate(JobHandle inputDeps)
   {
       // Schedule the job that will add Instantiate commands to the EntityCommandBuffer.
       var job = new SpawnJob
       {
           CommandBuffer = m_EndFrameBarrier.CreateCommandBuffer()
       }.ScheduleSingle(this, inputDeps);

       // We need to tell the barrier system which job it needs to complete before it can play back the commands.
       m_EndFrameBarrier.AddJobHandleForProducer(job);

       return job;
   }
}
</code></pre><p><strong>Note:</strong> this example uses IJobProcessComponentData.ScheduleSingle(), which performs the Job on a single thread. If you used the Schedule() method instead, the system uses parallel jobs to process the entities. In the parallel case, you must use a concurrent entity command buffer (EntityCommandBuffer.Concurrent).</p>
<p>See the  <a href="https://github.com/Unity-Technologies/EntityComponentSystemSamples">ECS samples repository</a> for the full example source code.</p>
<h3 id="using-the-index-parameter">Using the index parameter</h3>
<p>You can use the index when adding a command to a concurrent command buffer. You use concurrent command buffers when running Jobs that process entities in parallel. In an IJobProcessComponentDataWithEntity Job, the Job System process entities in parallel when you use the Schedule() method rather than the ScheduleSingle() method used in the example above. Concurrent command buffers should always be used for parallel Jobs to guarantee thread safety and deterministic execution of the buffer commands.</p>
<p>You can also use the index to reference the same entities across Jobs within the same system. For example, if you need to process a set of entities in multiple passes and collect temporary data along the way, you can use the index to insert the temporary data into a NativeArray in one Job and then use the index to access that data in a subsequent Job. (Naturally, you have to pass the same NativeArray to both Jobs.)</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/Unity-Technologies/dots/blob/organize-docs/doc-src/manual/com.unity.entities/entity_iteration_job.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            &nbsp;
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
