<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Scheduling a job from a job - why not? </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Scheduling a job from a job - why not? ">
    <meta name="generator" content="docfx 2.40.7.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="toc">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>

            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../../manual/ecs_principles_and_vision.html" title="Manual">Manual</a>
                      </li>
                      <li>
                          <a href="../../api/Unity.Collections.html" title="Script Reference">Script Reference</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="index.html" title="Jobs package" class="">Jobs package</a>
                    </li>
                    <li class="">
                      <a href="custom_job_types.html" title="Custom job types" class="">Custom job types</a>
                    </li>
                    <li class="active">
                      <a href="scheduling_a_job_from_a_job.html" title="Scheduling a job from a job" class="active">Scheduling a job from a job</a>
                    </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="scheduling-a-job-from-a-job---why-not">Scheduling a job from a job - why not?</h1>

<p>We have a couple of important principles that drive our design.</p>
<ul>
<li>Determinism by default: Determinism enables networked games, replay and debugging tools.</li>
<li>Safe: Race conditions are immediately reported, this makes writing jobified code significantly more approachable and simple.</li>
</ul>
<p>These two principles applied result in some choices and restrictions that we enforce.</p>
<h2 id="jobs-can-only-be-completed-on-the-main-thread---but-why">Jobs can only be completed on the main thread - but why?</h2>
<p>If you were to call <strong>JobHandle.Complete</strong> that leads to impossible to solve job scheduler deadlocks.
(We have tried this over the last couple years with the Unity C++ code base, and every single case has resulted in tears and us reverting such patterns in our code.) The deadlocks are rare but provably impossible to solve in all cases, they are heavily dependent on the timing of jobs.</p>
<h2 id="jobs-can-only-be-scheduled-on-the-main-thread---but-why">Jobs can only be scheduled on the main thread - but why?</h2>
<p>If you were to simply schedule a job from another job, but not call JobHandle.Complete from the job, then there is no way to guarantee determinism. The main thread has to call JobHandle.Complete(), but who passes that JobHandle to the main thread? How do you know the job that schedules the other job has already executed?</p>
<p>In summary, first instinct is to simply schedule jobs from other jobs, and then wait for jobs within a job.
Yet experience tells us that this is always a bad idea. So the C# job system does not support it.</p>
<h2 id="ok-but-how-do-i-process-workloads-where-i-dont-know-the-exact-size-upfront">OK, but how do I process workloads where I don&#39;t know the exact size upfront?</h2>
<p>It&#39;s totally fine to schedule jobs conservatively and then simply exit early and do nothing if it turns out the number of actual elements to process, when the job executes, is much less than the conservative number of elements that was determined at schedule time. </p>
<p>In fact this way of doing it leads to deterministic execution, and if the early exit can skip a whole batch of operations it&#39;s not really a performance issue.
Also, there is no possibility of causing internal job scheduler deadlocks.</p>
<p>For this purpose using <strong>IJobParallelForBatch</strong> as opposed to <strong>IJobParallelFor</strong> can be very useful since you can exit early on a whole batch.</p>
<pre><code>    public interface IJobParallelForBatch
    {
        void Execute(int startIndex, int count);
    }
</code></pre><!-- TODO: CODE EXAMPLE for sorting? -->
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/Unity-Technologies/dots/blob/organize-docs/doc-src/manual/com.unity.jobs/scheduling_a_job_from_a_job.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            &nbsp;
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
